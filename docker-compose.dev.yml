# GigaBot Development Docker Compose
# Usage: docker compose -f docker-compose.dev.yml up
# 
# Features:
# - Hot-reload for Python code (FastAPI server)
# - Separate frontend dev server with HMR
# - Volume mounts for live development

services:
  # Backend: FastAPI with uvicorn hot-reload
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gigabot-backend-dev
    restart: unless-stopped
    
    ports:
      - "18790:18790"
    
    volumes:
      # Mount source code for hot-reload
      - ./nanobot:/app/nanobot:ro
      # Configuration directory
      - ./config:/root/.nanobot
      # Workspace
      - ./workspace:/root/.nanobot/workspace
    
    environment:
      - PYTHONPATH=/app
      - RELOAD=true
      # LLM Provider API Keys
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      # Channel Tokens (optional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
    
    # Use FastAPI gateway with hot-reload
    command: ["gigabot", "gateway-v2", "--port", "18790", "--reload"]
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18790/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Frontend: Vite dev server with HMR
  frontend:
    image: node:20-slim
    container_name: gigabot-frontend-dev
    restart: unless-stopped
    
    working_dir: /app
    
    ports:
      - "5173:5173"
    
    volumes:
      - ./nanobot/ui/dashboard:/app
      - frontend-node-modules:/app/node_modules
    
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    
    environment:
      # Proxy API requests to backend
      - VITE_API_URL=http://backend:18790

volumes:
  frontend-node-modules:
